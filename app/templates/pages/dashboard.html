{% extends "base.html" %}

{% block title %}Dashboard - Job Tracker{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Page header -->
    <div class="page-header fade-in">
        <h1 class="reveal-text">Dashboard</h1>
        <p class="reveal-text">Overview of your job search progress</p>
    </div>

    <!-- Stats cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 stagger-children"
         hx-get="{{ url_for('views.stats_partial') }}"
         hx-trigger="load"
         hx-swap="innerHTML">
        <!-- Loading placeholder -->
        {% for _ in range(4) %}
        <div class="glass-card p-6">
            <div class="h-4 skeleton w-1/2 mb-3"></div>
            <div class="h-8 skeleton w-1/4"></div>
        </div>
        {% endfor %}
    </div>

    <!-- Stat breakdown (HTMX target) -->
    <div id="stat-breakdown" class="stagger-children"></div>

    <!-- Status breakdown -->
    <div class="glass-card fade-in">
        <div class="px-6 py-4 border-b" style="border-color: var(--border-glass);">
            <h2 class="text-lg font-semibold" style="color: var(--text-primary);">Application Status</h2>
        </div>
        <div class="p-6"
             hx-get="{{ url_for('views.status_breakdown_partial') }}"
             hx-trigger="load"
             hx-swap="innerHTML">
            <div class="space-y-3">
                <div class="h-6 skeleton w-full"></div>
                <div class="h-6 skeleton w-4/5"></div>
                <div class="h-6 skeleton w-3/5"></div>
            </div>
        </div>
    </div>

    <!-- Recent applications -->
    <div class="glass-card fade-in">
        <div class="px-6 py-4 border-b flex justify-between items-center" style="border-color: var(--border-glass);">
            <h2 class="text-lg font-semibold" style="color: var(--text-primary);">Recent Applications</h2>
            <a href="{{ url_for('views.applications') }}" class="text-sm font-medium" style="color: var(--accent-hover);">
                View all &rarr;
            </a>
        </div>
        <div hx-get="{{ url_for('views.recent_applications_partial') }}"
             hx-trigger="load"
             hx-swap="innerHTML">
            <div class="p-6 space-y-4">
                <div class="h-12 skeleton"></div>
                <div class="h-12 skeleton"></div>
                <div class="h-12 skeleton"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    var activeStatCard = null;

    function toggleStatCard(card, event) {
        var stat = card.getAttribute('data-stat');

        if (activeStatCard === stat) {
            // Clicking same card â€” collapse
            event.preventDefault();
            closeStatBreakdown();
            return;
        }

        // Remove active from all cards
        document.querySelectorAll('.stat-card').forEach(function(c) {
            c.classList.remove('stat-card-active');
        });

        // Set new active
        card.classList.add('stat-card-active');
        activeStatCard = stat;
    }

    function closeStatBreakdown() {
        var target = document.getElementById('stat-breakdown');
        if (target) {
            gsap.to(target, {
                opacity: 0,
                y: -10,
                duration: 0.3,
                ease: 'power2.in',
                onComplete: function() {
                    target.innerHTML = '';
                    gsap.set(target, { opacity: 1, y: 0 });
                }
            });
        }
        document.querySelectorAll('.stat-card').forEach(function(c) {
            c.classList.remove('stat-card-active');
        });
        activeStatCard = null;
    }

    // Animate breakdown in after HTMX swap
    document.addEventListener('htmx:afterSwap', function(e) {
        if (e.detail.target && e.detail.target.id === 'stat-breakdown') {
            var content = e.detail.target.querySelector('#stat-breakdown-content');
            if (content) {
                gsap.fromTo(content,
                    { opacity: 0, y: 20 },
                    { opacity: 1, y: 0, duration: 0.4, ease: 'power3.out' }
                );
            }
        }
    });
</script>
{% endblock %}
